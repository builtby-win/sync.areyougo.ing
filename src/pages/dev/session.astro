---
import BaseLayout from '../../layouts/base-layout.astro'
import { verifySession } from '../../lib/verify-session'

// Only allow access in dev mode or preview URLs
const hostname = Astro.url.hostname
const isPreviewUrl = hostname.includes('.pages.dev') || hostname.includes('.workers.dev')
const isDev = import.meta.env.DEV

if (!isDev && !isPreviewUrl) {
  return Astro.redirect('/')
}

// Get environment
const env = Astro.locals.runtime.env
const mainAppUrl = env.MAIN_APP_URL || 'https://areyougo.ing'

// Check if user is already authenticated
const user = await verifySession(Astro.request, mainAppUrl)
const isLoggedIn = !!user

// Determine main app session URL for getting the token
const mainAppSessionUrl = isDev ? 'http://localhost:4321/dev/session' : `${mainAppUrl}/dev/session`
---

<BaseLayout title="Session Transfer | Dev">
  <div class="min-h-[80vh] flex flex-col items-center justify-center px-4 py-12">
    <div class="w-full max-w-lg">
      <!-- Header -->
      <div class="text-center mb-8">
        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-yellow-500/10 text-yellow-600 text-sm font-medium mb-4">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          {isDev ? 'Development' : 'Preview URL'}
        </div>
        <h1 class="text-3xl font-bold mb-2">Session Transfer</h1>
        <p class="text-muted-foreground">
          Import your session from areyougo.ing to test locally
        </p>
      </div>

      {/* Already logged in - show success */}
      {isLoggedIn && (
        <div class="bg-card rounded-lg border border-green-500/30 bg-green-500/10 p-6 mb-6">
          <div class="flex items-center gap-3">
            <svg class="w-6 h-6 text-green-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <div>
              <h2 class="text-lg font-semibold text-green-700">
                You're signed in!
              </h2>
              <p class="text-sm text-green-600">
                Logged in as {user.email}
              </p>
            </div>
          </div>
          <a
            href="/"
            class="mt-4 inline-flex items-center justify-center gap-2 w-full px-4 py-3 rounded-lg bg-green-600 text-white font-medium hover:bg-green-700 transition-colors"
          >
            Go to Setup
          </a>
        </div>
      )}

      {/* Not logged in - show import flow */}
      {!isLoggedIn && (
        <>
          <!-- Step 1: Get token from main app -->
          <div class="bg-card rounded-lg border border-border p-6 mb-4">
            <div class="flex items-center gap-3 mb-3">
              <span class="flex items-center justify-center w-6 h-6 rounded-full bg-primary text-primary-foreground text-xs font-bold">1</span>
              <h2 class="text-lg font-semibold">
                Get Token from Main App
              </h2>
            </div>
            <p class="text-sm text-muted-foreground mb-4">
              Open areyougo.ing, sign in, then copy your session token.
            </p>
            <a
              href={mainAppSessionUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center justify-center gap-2 w-full px-4 py-3 rounded-lg bg-primary text-primary-foreground font-medium hover:opacity-90 transition-opacity"
            >
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
              Open areyougo.ing/dev/session
            </a>
          </div>

          <!-- Step 2: Paste token here -->
          <div class="bg-card rounded-lg border border-border p-6">
            <div class="flex items-center gap-3 mb-3">
              <span class="flex items-center justify-center w-6 h-6 rounded-full bg-primary text-primary-foreground text-xs font-bold">2</span>
              <h2 class="text-lg font-semibold">
                Paste Token Here
              </h2>
            </div>
            <p class="text-sm text-muted-foreground mb-4">
              After copying the token from the main app, paste it below.
            </p>
            <form id="import-form" class="space-y-4">
              <input
                type="text"
                id="import-token"
                name="token"
                placeholder="Paste session token here..."
                class="w-full px-4 py-3 rounded-lg border border-border bg-background text-sm font-mono placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/20"
              />
              <button
                type="submit"
                class="w-full px-4 py-3 rounded-lg bg-primary text-primary-foreground font-medium hover:opacity-90 transition-opacity"
              >
                Import Session
              </button>
            </form>
            <p id="import-status" class="mt-3 text-sm hidden"></p>
          </div>
        </>
      )}

      <!-- Back link -->
      <div class="mt-8 text-center">
        <a
          href="/"
          class="text-sm text-muted-foreground hover:text-foreground inline-flex items-center gap-1"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          Back to Setup
        </a>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  // Import form handler
  const importForm = document.getElementById('import-form');
  const importStatus = document.getElementById('import-status');

  importForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const tokenInput = document.getElementById('import-token') as HTMLInputElement;
    const token = tokenInput?.value?.trim();

    if (!token) {
      if (importStatus) {
        importStatus.textContent = 'Please enter a session token';
        importStatus.className = 'mt-3 text-sm text-red-600';
        importStatus.classList.remove('hidden');
      }
      return;
    }

    // Set the cookie with the session token
    const maxAge = 60 * 60 * 24 * 365; // 1 year
    document.cookie = `better-auth.session_token=${encodeURIComponent(token)}; path=/; max-age=${maxAge}; SameSite=Lax`;

    if (importStatus) {
      importStatus.textContent = 'Session imported! Verifying...';
      importStatus.className = 'mt-3 text-sm text-blue-600';
      importStatus.classList.remove('hidden');
    }

    // Reload to verify the session works
    setTimeout(() => {
      window.location.reload();
    }, 500);
  });
</script>
