---
import BaseLayout from '../layouts/base-layout.astro'
import SetupWizard from '../components/setup-wizard'
import SyncSettings from '../components/sync-settings'
import { verifySession } from '../lib/verify-session'
import { getDb } from '../lib/db'
import { imapCredentials } from '../lib/schema'
import { eq } from 'drizzle-orm'

// Get environment and verify session
const mainAppUrl = process.env.MAIN_APP_URL || 'https://areyougo.ing'
const user = await verifySession(Astro.request, mainAppUrl)

// Check if user already has credentials set up
let existingCredentials: {
  provider: string
  imapEmail: string
  lastSyncAt: Date | null
  syncMode: string
  lastManualSyncAt: Date | null
} | null = null

if (user) {
  const db = getDb()
  const result = await db
    .select({
      provider: imapCredentials.provider,
      imapEmail: imapCredentials.imapEmail,
      lastSyncAt: imapCredentials.lastSyncAt,
      syncMode: imapCredentials.syncMode,
      lastManualSyncAt: imapCredentials.lastManualSyncAt,
    })
    .from(imapCredentials)
    .where(eq(imapCredentials.userId, user.id))
    .limit(1)

  if (result.length > 0) {
    existingCredentials = result[0]
  }
}

// Convert Date to timestamp for client components
const credentialsForClient = existingCredentials
  ? {
      provider: existingCredentials.provider,
      imapEmail: existingCredentials.imapEmail,
      lastSyncAt: existingCredentials.lastSyncAt?.getTime() ? Math.floor(existingCredentials.lastSyncAt.getTime() / 1000) : null,
      syncMode: existingCredentials.syncMode,
      lastManualSyncAt: existingCredentials.lastManualSyncAt?.getTime() ? Math.floor(existingCredentials.lastManualSyncAt.getTime() / 1000) : null,
    }
  : null
---

<BaseLayout>
  <div class="min-h-[80vh] flex flex-col items-center justify-center px-4 py-12">
    <div class="w-full max-w-lg">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold mb-2">Email Sync Setup</h1>
        <p class="text-muted-foreground">
          Connect your email to automatically import ticket confirmations
        </p>
      </div>

      {!user ? (
        <!-- Not logged in -->
        <div class="bg-card rounded-lg border border-border p-6 text-center">
          <p class="text-muted-foreground mb-4">
            Please sign in to areyougo.ing first to set up email sync.
          </p>
          <a
            href={`${mainAppUrl}/dashboard`}
            class="inline-flex items-center justify-center px-4 py-2 bg-primary text-primary-foreground rounded-md font-medium hover:opacity-90 transition-opacity"
          >
            Sign in to areyougo.ing
          </a>
        </div>
      ) : credentialsForClient ? (
        <!-- Has credentials - show sync settings -->
        <SyncSettings
          client:load
          user={{ id: user.id, email: user.email, name: user.name }}
          credentials={credentialsForClient}
          onUpdateSettings={() => window.location.reload()}
        />
        <div class="mt-4 text-center">
          <button
            type="button"
            onclick="document.getElementById('change-settings').classList.toggle('hidden')"
            class="text-sm text-muted-foreground hover:text-foreground transition-colors"
          >
            Change email provider or credentials
          </button>
          <div id="change-settings" class="hidden mt-4">
            <SetupWizard
              client:load
              user={{ id: user.id, email: user.email, name: user.name }}
              existingCredentials={credentialsForClient}
            />
          </div>
        </div>
      ) : (
        <!-- No credentials - show setup wizard -->
        <SetupWizard
          client:load
          user={{ id: user.id, email: user.email, name: user.name }}
          existingCredentials={null}
        />
      )}

      <!-- Transparency Notice -->
      <div class="mt-8 p-4 bg-card/50 rounded-lg border border-border">
        <h3 class="font-semibold mb-2 text-sm">Privacy & Transparency</h3>
        <ul class="text-sm text-muted-foreground space-y-1">
          <li>• Your password is encrypted and never logged</li>
          <li>• We only read emails from <a href="https://github.com/builtby-win/sync.areyougo.ing/blob/main/src/lib/approved-senders.ts" target="_blank" class="text-primary hover:underline">approved ticket vendors</a></li>
          <li>• Use an app-specific password (not your main password)</li>
          <li>• You can delete your data anytime</li>
          <li>• This code is <a href="https://github.com/builtby-win/sync.areyougo.ing" target="_blank" class="text-primary hover:underline">open source</a></li>
        </ul>
      </div>
    </div>
  </div>
</BaseLayout>
