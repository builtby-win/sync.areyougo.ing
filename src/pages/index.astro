---
import BaseLayout from '../layouts/base-layout.astro'
import SetupWizard from '../components/setup-wizard'
import AccountsList from '../components/accounts-list'
import { verifySession } from '../lib/verify-session'
import { getDb } from '../lib/db'
import { imapCredentials } from '../lib/schema'
import { eq } from 'drizzle-orm'

// Get environment and verify session
const mainAppUrl = process.env.MAIN_APP_URL || 'https://areyougo.ing'
const isDev = process.env.NODE_ENV !== 'production'
const fallbackRedirectUrl = `${mainAppUrl}/wrapped`
const redirectUrlParam = Astro.url.searchParams.get('redirectUrl')

let redirectUrl: string | null = null

if (redirectUrlParam) {
  try {
    const parsed = new URL(redirectUrlParam)
    const mainAppHost = new URL(mainAppUrl).hostname
    const allowedHosts = new Set([mainAppHost])
    if (isDev) {
      allowedHosts.add('localhost')
      allowedHosts.add('127.0.0.1')
    }

    const allowedProtocols = isDev ? ['http:', 'https:'] : ['https:']

    if (allowedProtocols.includes(parsed.protocol) && allowedHosts.has(parsed.hostname)) {
      redirectUrl = parsed.toString()
    }
  } catch {
    redirectUrl = null
  }
}

const redirectPath = redirectUrl
  ? `${new URL(redirectUrl).pathname}${new URL(redirectUrl).search}${new URL(redirectUrl).hash}`
  : '/wrapped'
const mainAppLoginUrl = `${mainAppUrl}/login?redirect=${encodeURIComponent(redirectPath)}`
let user: Awaited<ReturnType<typeof verifySession>> = null
let connectionError: string | null = null

try {
  user = await verifySession(Astro.request, mainAppUrl)
} catch (error) {
  if (error instanceof Error && error.message.includes('Cannot connect to main app')) {
    connectionError = error.message
  } else {
    throw error
  }
}

// Check if user has any credentials set up
let existingCredentials: Array<{
  id: string
  provider: string
  imapEmail: string
  lastSyncAt: Date | null
  syncMode: string
  lastManualSyncAt: Date | null
}> = []

if (user) {
  const db = getDb()
  existingCredentials = await db
    .select({
      id: imapCredentials.id,
      provider: imapCredentials.provider,
      imapEmail: imapCredentials.imapEmail,
      lastSyncAt: imapCredentials.lastSyncAt,
      syncMode: imapCredentials.syncMode,
      lastManualSyncAt: imapCredentials.lastManualSyncAt,
    })
    .from(imapCredentials)
    .where(eq(imapCredentials.userId, user.id))
    .orderBy(imapCredentials.createdAt)
}

// Convert Date to timestamp for client components
const accountsForClient = existingCredentials.map((cred) => ({
  id: cred.id,
  provider: cred.provider,
  imapEmail: cred.imapEmail,
  lastSyncAt: cred.lastSyncAt?.getTime() ? Math.floor(cred.lastSyncAt.getTime() / 1000) : null,
  syncMode: cred.syncMode,
  lastManualSyncAt: cred.lastManualSyncAt?.getTime()
    ? Math.floor(cred.lastManualSyncAt.getTime() / 1000)
    : null,
}))
---

<BaseLayout>
  <div class="min-h-[80vh] flex flex-col items-center justify-center px-4 py-12">
    <div class="w-full max-w-lg">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold mb-2">Email Sync Setup</h1>
        <p class="text-muted-foreground">
          Connect your email to automatically import ticket confirmations
        </p>
      </div>

      {connectionError ? (
        <!-- Connection Error -->
        <div class="bg-destructive/10 border border-destructive/50 rounded-lg p-6 mb-6">
          <div class="flex items-start gap-3">
            <div class="text-2xl">X</div>
            <div class="flex-1">
              <h3 class="font-semibold text-destructive mb-2">Cannot Connect to Main App</h3>
              <p class="text-sm text-muted-foreground mb-4">
                The sync server (running in Docker) can't reach the main areyougo.ing app.
              </p>
              <div class="bg-background/50 rounded-md p-4 font-mono text-sm mb-4">
                <div class="text-muted-foreground mb-2">Run this in the main app directory:</div>
                <code class="text-foreground">cd ../areyougo.ing && pnpm dev:host</code>
              </div>
              <p class="text-xs text-muted-foreground">
                The <code class="bg-muted px-1 py-0.5 rounded">--host</code> flag allows Docker containers to connect to your local development server.
              </p>
            </div>
          </div>
        </div>
      ) : !user ? (
        <!-- Not logged in -->
        <div class="bg-card rounded-lg border border-border p-6 text-center">
          <p class="text-muted-foreground mb-4">
            Please sign in to areyougo.ing first to set up email sync.
          </p>
          <a
            href={mainAppLoginUrl}
            class="inline-flex items-center justify-center px-4 py-2 bg-primary text-primary-foreground rounded-md font-medium hover:opacity-90 transition-opacity"
          >
            Sign in to areyougo.ing
          </a>
        </div>
      ) : accountsForClient.length > 0 ? (
        <!-- Has accounts - show accounts list -->
        <AccountsList
          client:load
          user={{ id: user.id, email: user.email, name: user.name }}
          accounts={accountsForClient}
          redirectUrl={redirectUrl ?? fallbackRedirectUrl}
        />
      ) : (
        <!-- No credentials - show setup wizard -->
        <SetupWizard
          client:load
          user={{ id: user.id, email: user.email, name: user.name }}
          existingCredentials={null}
        />
      )}

      <!-- Transparency Notice -->
      <div class="mt-8 p-4 bg-card/50 rounded-lg border border-border">
        <h3 class="font-semibold mb-2 text-sm">Privacy & Transparency</h3>
        <ul class="text-sm text-muted-foreground space-y-1">
          <li>* Your password is encrypted and never logged</li>
          <li>* We only read emails from <a href="https://github.com/builtby-win/sync.areyougo.ing/blob/main/src/lib/approved-senders.ts" target="_blank" class="text-primary hover:underline">approved ticket vendors</a></li>
          <li>* Use an app-specific password (not your main password)</li>
          <li>* You can delete your data anytime</li>
          <li>* This code is <a href="https://github.com/builtby-win/sync.areyougo.ing" target="_blank" class="text-primary hover:underline">open source</a></li>
        </ul>
      </div>
    </div>
  </div>
</BaseLayout>
